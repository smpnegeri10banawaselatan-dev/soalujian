<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soal Mid Semester Kelas 7"</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; background:#f2f2f2; }
    h1 { text-align:center; margin-bottom:10px; }
    #timer { text-align:center; font-weight:bold; margin-bottom:20px; }
    .soal { background:#fff; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .opsi { margin: 8px 0; }
    button { background:#4CAF50; color:#fff; padding:12px 25px; border:none; border-radius:6px; font-size:16px; cursor:pointer; display:block; margin:30px auto 0; }
    button:disabled { background:grey; cursor:not-allowed; }
    .hasil { background:#fff; padding:20px; border-radius:8px; text-align:center; font-size:1.2rem; margin-top:30px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .correct { color:green; font-weight:bold; }
    .wrong { color:red; font-weight:bold; }
  </style>
</head>
<body>

<h1>Soal Ujian Pilihan Ganda</h1>
<div id="timer">Loading timer...</div>

<form id="quizForm"></form>

<button id="submitBtn" disabled>Loading soal...</button>

<div id="result" class="hasil" style="display:none;"></div>

<script>
  // CSV soal dari Google Sheets
  const csvUrl = "https://docs.google.com/spreadsheets/d/1RDTnOICKl6wKqBryd7BEO4FlXV0td7rfLm7-pZj8Yls/export?format=csv&gid=0";

  // Ganti ini dengan URL Web App Google Apps Script kamu
  const googleAppsScriptUrl = "https://script.google.com/macros/s/AKfycbwrSB7vTtkp6jAUS8fyv1IdXtTQPSmr2UbUYEojyrtqsax_aSrPNpgDspsuoWX3xsoY/exec";

  let questions = [];
  const quizForm = document.getElementById('quizForm');
  const resultDiv = document.getElementById('result');
  const submitBtn = document.getElementById('submitBtn');
  const timerDiv = document.getElementById('timer');

  const totalTime = 10 * 60; // 10 menit (dalam detik)
  let timeLeft = totalTime;
  let timerInterval = null;
  let isSubmitted = false;

  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    const data = [];

    for(let i=1; i<lines.length; i++){
      const row = lines[i].split(',');
      const obj = {};
      headers.forEach((header, index) => {
        obj[header.trim()] = row[index] ? row[index].trim() : "";
      });
      data.push(obj);
    }
    return data;
  }

  function renderQuestions() {
    quizForm.innerHTML = "";
    questions.forEach((q, index) => {
      const div = document.createElement('div');
      div.className = 'soal';
      div.innerHTML = `
        <h3>${q.No}. ${q.Soal}</h3>
        ${['A','B','C','D'].map(opt => `
          <div class="opsi">
            <label>
              <input type="radio" name="q${index}" value="${opt}" />
              ${opt}. ${q[opt]}
            </label>
          </div>
        `).join('')}
        <div class="feedback" id="feedback${index}" style="margin-top: 8px;"></div>
      `;
      quizForm.appendChild(div);
    });
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Jawaban";
  }

  function renderTimer() {
    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const seconds = (timeLeft % 60).toString().padStart(2, '0');
    timerDiv.textContent = `Waktu tersisa: ${minutes}:${seconds}`;
  }

  function startTimer() {
    renderTimer();
    timerInterval = setInterval(() => {
      if(timeLeft <= 0){
        clearInterval(timerInterval);
        if(!isSubmitted) checkAnswers();
        return;
      }
      timeLeft--;
      renderTimer();
    }, 1000);
  }

  function sendResultToSheet(resultData) {
    fetch(googleAppsScriptUrl, {
      method: "POST",
      body: JSON.stringify(resultData),
      headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(data => {
      if(data.result === "success"){
        alert("Hasil berhasil disimpan ke Google Sheets!");
      } else {
        alert("Gagal menyimpan hasil: " + data.message);
      }
    })
    .catch(err => {
      alert("Error saat menyimpan hasil: " + err.message);
    });
  }

  function checkAnswers() {
    if(isSubmitted) return;
    isSubmitted = true;

    let score = 0;
    let userAnswers = [];

    questions.forEach((q, index) => {
      const selected = document.querySelector(`input[name="q${index}"]:checked`);
      const feedbackEl = document.getElementById(`feedback${index}`);

      if(selected){
        userAnswers.push(`${q.No}: ${selected.value}`);
        if(selected.value === q.Jawaban){
          score++;
          feedbackEl.innerHTML = `<span class="correct">Benar!</span>`;
        } else {
          feedbackEl.innerHTML = `<span class="wrong">Salah! Jawaban benar: ${q.Jawaban}</span>`;
        }
      } else {
        userAnswers.push(`${q.No}: Tidak dijawab`);
        feedbackEl.innerHTML = `<span class="wrong">Belum memilih jawaban!</span>`;
      }
    });

    submitBtn.disabled = true;
    timerDiv.textContent = "Waktu habis atau soal telah disubmit.";

    resultDiv.style.display = 'block';
    resultDiv.textContent = `Skor Anda: ${score} dari ${questions.length}`;

    let nama = prompt("Masukkan nama Anda:");
    if(!nama) nama = "Anonim";

    const resultData = {
      nama: nama,
      jawaban: userAnswers.join("; "),
      skor: score,
      waktu: totalTime - timeLeft
    };

    sendResultToSheet(resultData);
  }

  submitBtn.addEventListener('click', e => {
    e.preventDefault();
    checkAnswers();
    window.scrollTo(0, document.body.scrollHeight);
    clearInterval(timerInterval);
  });

  fetch(csvUrl)
    .then(res => res.text())
    .then(text => {
      questions = parseCSV(text);
      renderQuestions();
      startTimer();
    })
    .catch(err => {
      quizForm.innerHTML = "<p>Gagal memuat soal. Periksa koneksi atau akses Google Sheet.</p>";
      submitBtn.disabled = true;
      submitBtn.textContent = "Gagal Memuat";
      timerDiv.textContent = "";
      console.error(err);
    });
</script>

</body>
</html>
