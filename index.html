<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ujian Mid Semester Kelas 7</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">

  <div class="container py-5">
    <!-- Logo -->
    <div class="text-center mb-4">
      <img src="https://donggala.go.id/asset/logo/donggala3.png" alt="Logo Sekolah" class="mx-auto h-20" />
    </div>

    <h1 class="text-3xl text-center font-bold mb-4">Ujian Mid Semester - Kelas 7</h1>
    <div id="timer" class="text-center text-lg font-semibold text-red-600 mb-4">Loading timer...</div>

    <div id="quizContainer" class="bg-white p-4 rounded shadow">
      <form id="quizForm" class="space-y-4"></form>

      <div class="flex justify-between mt-6">
        <button type="button" id="prevBtn" class="btn btn-secondary" disabled>Sebelumnya</button>
        <button type="button" id="nextBtn" class="btn btn-primary">Selanjutnya</button>
      </div>

      <div class="text-center mt-5">
        <button id="submitBtn" class="btn btn-success" style="display:none;">Kumpulkan Jawaban</button>
      </div>
    </div>

    <div id="result" class="mt-5 p-4 bg-white rounded shadow text-center text-xl font-bold hidden"></div>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/1RDTnOICKl6wKqBryd7BEO4FlXV0td7rfLm7-pZj8Yls/export?format=csv&gid=0";
    const googleAppsScriptUrl = "https://script.google.com/macros/s/AKfycbzpRB7JiD7TSAmeoTciqgAAWamw3E6EayI5_rFcBgLh2s3G-Sx2CN39Ybo-8GYHPQZo/exec";

    let questions = [];
    let currentIndex = 0;
    let timeLeft = 10 * 60;
    let isSubmitted = false;
    const quizForm = document.getElementById("quizForm");
    const timerDiv = document.getElementById("timer");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const resultDiv = document.getElementById("result");

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      const data = [];

      for(let i=1; i<lines.length; i++){
        const row = lines[i].split(',');
        const obj = {};
        headers.forEach((header, index) => {
          obj[header.trim()] = row[index] ? row[index].trim() : "";
        });
        data.push(obj);
      }
      return data;
    }

    function renderQuestion(index) {
      const q = questions[index];
      quizForm.innerHTML = `
        <div class="text-lg font-semibold mb-2">${q.No}. ${q.Soal}</div>
        ${q.Gambar ? `<img src="${q.Gambar}" class="mb-3 max-w-full h-auto rounded border">` : ''}
        ${['A','B','C','D'].map(opt => `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q${index}" id="q${index}_${opt}" value="${opt}">
            <label class="form-check-label" for="q${index}_${opt}">${opt}. ${q[opt]}</label>
          </div>
        `).join('')}
      `;

      const selected = document.querySelector(`input[name="q${index}"][value="${q.userAnswer || ''}"]`);
      if (selected) selected.checked = true;

      prevBtn.disabled = index === 0;
      nextBtn.style.display = index === questions.length - 1 ? "none" : "inline-block";
      submitBtn.style.display = index === questions.length - 1 ? "inline-block" : "none";
    }

    function saveAnswer(index) {
      const selected = document.querySelector(`input[name="q${index}"]:checked`);
      questions[index].userAnswer = selected ? selected.value : null;
    }

    function renderTimer() {
      const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const s = String(timeLeft % 60).padStart(2, '0');
      timerDiv.textContent = `Waktu Tersisa: ${m}:${s}`;
    }

    function startTimer() {
      renderTimer();
      setInterval(() => {
        if (timeLeft <= 0 && !isSubmitted) {
          checkAnswers();
        }
        if (timeLeft > 0) {
          timeLeft--;
          renderTimer();
        }
      }, 1000);
    }

    function checkAnswers() {
      isSubmitted = true;
      let score = 0;
      let jawabanUser = [];

      questions.forEach((q, i) => {
        const jawaban = q.userAnswer || "Tidak dijawab";
        jawabanUser.push(`${q.No}: ${jawaban}`);
        if (jawaban === q.Jawaban) score++;
      });

      const nama = prompt("Masukkan nama Anda:") || "Anonim";
      resultDiv.innerHTML = `Skor Anda: ${score} dari ${questions.length}`;
      resultDiv.classList.remove("hidden");

      const resultData = {
        nama,
        jawaban: jawabanUser.join("; "),
        skor: score,
        waktu: 600 - timeLeft
      };

      fetch(googleAppsScriptUrl, {
        method: "POST",
        body: JSON.stringify(resultData),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.result !== "success") {
          alert("Gagal menyimpan: " + data.message);
        }
      }).catch(err => {
        alert("Error: " + err.message);
      });
    }

    prevBtn.addEventListener("click", () => {
      saveAnswer(currentIndex);
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion(currentIndex);
      }
    });

    nextBtn.addEventListener("click", () => {
      saveAnswer(currentIndex);
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion(currentIndex);
      }
    });

    submitBtn.addEventListener("click", () => {
      saveAnswer(currentIndex);
      checkAnswers();
    });

    fetch(csvUrl)
      .then(res => res.text())
      .then(text => {
        questions = parseCSV(text);
        renderQuestion(0);
        startTimer();
      })
      .catch(err => {
        quizForm.innerHTML = "<p class='text-red-600'>Gagal memuat soal. Periksa koneksi atau izin file Google Sheets.</p>";
        console.error(err);
      });
  </script>

</body>
</html>
