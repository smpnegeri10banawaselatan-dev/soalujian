<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ujian Mid Semester Kelas 7</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">

<div class="container py-5">

  <div class="text-center mb-4">
    <img src="https://donggala.go.id/asset/logo/donggala3.png" alt="Logo Sekolah" class="mx-auto h-20" />
  </div>

  <h1 class="text-3xl text-center font-bold mb-4">Ujian Mid Semester - Kelas 7</h1>

  <div id="loginDiv" class="bg-white p-4 rounded shadow max-w-md mx-auto">
    <h2 class="text-xl font-semibold mb-3">Pilih Nama Siswa</h2>
    <select id="siswaSelect" class="form-select mb-3">
      <option value="">-- Pilih Siswa --</option>
    </select>
    <div id="biodata" class="mb-3 text-sm"></div>
    <button id="startBtn" class="btn btn-primary" disabled>Mulai Ujian</button>
  </div>

  <div id="timer" class="text-center text-lg font-semibold text-red-600 my-4 hidden">Loading timer...</div>

  <div class="row hidden" id="quizSection">
    <div class="col-md-9">
      <div id="quizContainer" class="bg-white p-4 rounded shadow">
        <form id="quizForm" class="space-y-4"></form>

        <div class="flex justify-between mt-6">
          <button type="button" id="prevBtn" class="btn btn-secondary" disabled>Sebelumnya</button>
          <button type="button" id="nextBtn" class="btn btn-primary">Selanjutnya</button>
        </div>

        <div class="text-center mt-5">
          <button id="submitBtn" class="btn btn-success" style="display:none;">Kumpulkan Jawaban</button>
        </div>
      </div>

      <div id="result" class="mt-5 p-4 bg-white rounded shadow text-center text-xl font-bold hidden"></div>
    </div>

    <div class="col-md-3">
      <div class="bg-white p-3 rounded shadow">
        <h2 class="text-lg font-semibold mb-3 text-center">Nomor Soal</h2>
        <div id="questionNav" class="grid grid-cols-5 gap-2"></div>
        <p id="progress" class="text-sm font-semibold text-blue-600 mt-3 text-center"></p>
      </div>
    </div>
  </div>

</div>

<script>
// URL Spreadsheet dan Apps Script
const siswaUrl = "https://docs.google.com/spreadsheets/d/2PACX-1vQBmQ-qLgHUNJK2Ex42wOMNdFcOXimLe5XjbGIR7s0Tkwcz9o0Y8KJorWv7XXMprivlQpoubO_TsPNR/export?format=csv&gid=1939472161";
const csvUrl = "https://docs.google.com/spreadsheets/d/2PACX-1vQBmQ-qLgHUNJK2Ex42wOMNdFcOXimLe5XjbGIR7s0Tkwcz9o0Y8KJorWv7XXMprivlQpoubO_TsPNR/export?format=csv&gid=0";
const googleAppsScriptUrl = "https://script.google.com/macros/s/AKfycbxik9K__gEsYJ6cpZEYar0_tS936jw0C7wd2HQYmE0UfhtM5GsMgRaCIQqqZhjNxy90/exec"; 

let siswaData = [];
let questions = [];
let currentIndex = 0;
let timeLeft = 90*60;
let isSubmitted = false;
let currentSiswa = {};

const loginDiv = document.getElementById("loginDiv");
const siswaSelect = document.getElementById("siswaSelect");
const biodataDiv = document.getElementById("biodata");
const startBtn = document.getElementById("startBtn");
const quizSection = document.getElementById("quizSection");
const quizForm = document.getElementById("quizForm");
const timerDiv = document.getElementById("timer");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
const resultDiv = document.getElementById("result");
const questionNav = document.getElementById("questionNav");
const progressDiv = document.getElementById("progress");

// Ambil data siswa
fetch(siswaUrl)
  .then(res => {
    if (!res.ok) throw new Error("Gagal mengambil data siswa.");
    return res.text();
  })
  .then(text => {
    // Menghapus karakter BOM jika ada
    const cleanText = text.startsWith('\uFEFF') ? text.substring(1) : text;
    const lines = cleanText.trim().split("\n");
    if (lines.length <= 1) {
      console.error("Data siswa kosong atau tidak valid.");
      return;
    }
    for (let i = 1; i < lines.length; i++) {
      const row = lines[i].split(",");
      if (row.length >= 6) { // Pastikan baris memiliki jumlah kolom yang memadai
        const obj = {
          nama: row[0],
          kelas: row[1],
          jk: row[2],
          nisn: row[3],
          tempat: row[4],
          tgl: row[5]
        };
        siswaData.push(obj);
        const option = document.createElement("option");
        option.value = i - 1;
        option.textContent = obj.nama;
        siswaSelect.appendChild(option);
      }
    }
  })
  .catch(err => {
    alert("Error: " + err.message);
    console.error(err);
  });

siswaSelect.addEventListener("change", ()=>{
  const idx = siswaSelect.value;
  if(idx===""){
    biodataDiv.innerHTML="";
    startBtn.disabled=true;
  } else {
    currentSiswa = siswaData[idx];
    biodataDiv.innerHTML = `
      Kelas: ${currentSiswa.kelas}<br>
      JK: ${currentSiswa.jk}<br>
      NISN: ${currentSiswa.nisn}<br>
      Tempat Lahir: ${currentSiswa.tempat}<br>
      Tanggal Lahir: ${currentSiswa.tgl}
    `;
    startBtn.disabled=false;
  }
});

startBtn.addEventListener("click", ()=>{
  loginDiv.classList.add("hidden");
  quizSection.classList.remove("hidden");
  timerDiv.classList.remove("hidden");
  fetch(csvUrl)
    .then(res => {
      if (!res.ok) throw new Error("Gagal mengambil data soal.");
      return res.text();
    })
    .then(text=>{
      questions = parseCSV(text);
      if (questions.length === 0) {
        alert("Soal ujian tidak ditemukan. Periksa spreadsheet Anda.");
        return;
      }
      buildNav();
      renderQuestion(0);
      startTimer();
    })
    .catch(err => {
      alert("Error: " + err.message);
      console.error(err);
    });
});

function parseCSV(text){
  const cleanText = text.startsWith('\uFEFF') ? text.substring(1) : text;
  const lines = cleanText.trim().split("\n");
  const headers = lines[0].split(",");
  const data = [];
  for(let i=1;i<lines.length;i++){
    const row = lines[i].split(",");
    const obj = {};
    headers.forEach((h,j)=>obj[h.trim()]=row[j]?row[j].trim():"");
    data.push(obj);
  }
  return data;
}

function renderQuestion(index){
  const q = questions[index];
  quizForm.innerHTML = `
    <div class="text-lg font-semibold mb-2">${q.No}. ${q.Soal}</div>
    ${q.Gambar ? `<img src="${q.Gambar}" class="mb-3 max-w-full h-auto rounded border">` : ""}
    ${["A","B","C","D"].map(opt=>`
      <div class="form-check">
        <input class="form-check-input" type="radio" name="q${index}" id="q${index}_${opt}" value="${opt}">
        <label class="form-check-label" for="q${index}_${opt}">${opt}. ${q[opt]}</label>
      </div>
    `).join("")}
  `;
  const selected = document.querySelector(`input[name="q${index}"][value="${q.userAnswer||""}"]`);
  if(selected) selected.checked=true;

  prevBtn.disabled = index===0;
  nextBtn.style.display = index===questions.length-1?"none":"inline-block";
  submitBtn.style.display = index===questions.length-1?"inline-block":"none";

  updateNav();
}

function saveAnswer(index){
  const selected = document.querySelector(`input[name="q${index}"]:checked`);
  questions[index].userAnswer = selected?selected.value:null;
  updateNav();
}

function buildNav(){
  questionNav.innerHTML="";
  questions.forEach((q,i)=>{
    const btn = document.createElement("button");
    btn.textContent=q.No;
    btn.className="w-10 h-10 rounded text-white font-bold text-sm transition-colors duration-200 bg-gray-400";
    btn.onclick=()=>{saveAnswer(currentIndex); currentIndex=i; renderQuestion(i);};
    questionNav.appendChild(btn);
  });
  updateProgress();
}

function updateNav(){
  [...questionNav.children].forEach((btn,i)=>{
    btn.className="w-10 h-10 rounded text-white font-bold text-sm transition-colors duration-200 " +
      (i===currentIndex?"bg-blue-600":(questions[i].userAnswer?"bg-green-500":"bg-gray-400"));
  });
  updateProgress();
}

function updateProgress(){
  const answered = questions.filter(q=>q.userAnswer).length;
  progressDiv.textContent=`Terjawab: ${answered} / ${questions.length}`;
}

function renderTimer(){
  const m = String(Math.floor(timeLeft/60)).padStart(2,"0");
  const s = String(timeLeft%60).padStart(2,"0");
  timerDiv.textContent=`Waktu Tersisa: ${m}:${s}`;
}

function startTimer(){
  renderTimer();
  setInterval(()=>{
    if(timeLeft<=0 && !isSubmitted) checkAnswers();
    if(timeLeft>0){timeLeft--; renderTimer();}
  },1000);
}

function checkAnswers(){
  isSubmitted=true;
  let score=0;
  let jawabanUser=[];
  questions.forEach(q=>{
    const jawaban = q.userAnswer || "Tidak dijawab";
    jawabanUser.push(`${q.No}: ${jawaban}`);
    if(jawaban===q.Jawaban) score++;
  });
  resultDiv.innerHTML = `Skor Anda: ${score} dari ${questions.length}`;
  resultDiv.classList.remove("hidden");

  const resultData = {
    nama: currentSiswa.nama,
    kelas: currentSiswa.kelas,
    jk: currentSiswa.jk,
    nisn: currentSiswa.nisn,
    tempat: currentSiswa.tempat,
    tgl: currentSiswa.tgl,
    jawaban: jawabanUser.join("; "),
    skor: score,
    waktu: (90*60)-timeLeft
  };

  fetch(googleAppsScriptUrl,{
    method:"POST",
    body: JSON.stringify(resultData),
    headers: {"Content-Type":"application/json"}
  }).then(res=>res.json())
    .then(data=>{
      if(data.result!=="success") alert("Gagal menyimpan: "+data.message);
    }).catch(err=>{
      alert("Error: "+err.message);
    });
}

prevBtn.addEventListener("click", ()=>{saveAnswer(currentIndex); if(currentIndex>0){currentIndex--; renderQuestion(currentIndex);}});
nextBtn.addEventListener("click", ()=>{saveAnswer(currentIndex); if(currentIndex<questions.length-1){currentIndex++; renderQuestion(currentIndex);}});
submitBtn.addEventListener("click", ()=>{saveAnswer(currentIndex); checkAnswers();});
</script>

</body>
</html>
